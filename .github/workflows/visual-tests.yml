# Atlas Desktop - Visual Regression Testing CI Workflow
#
# Runs visual regression tests on pull requests and pushes to main branches.
# Generates diff images for visual changes and uploads reports.

name: Visual Regression Tests

on:
  push:
    branches: [main, master, orchestrator]
    paths:
      - 'src/renderer/**'
      - 'tests/visual/**'
      - 'playwright.config.ts'
      - 'package.json'
  pull_request:
    branches: [main, master, orchestrator]
    paths:
      - 'src/renderer/**'
      - 'tests/visual/**'
      - 'playwright.config.ts'
      - 'package.json'
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: 'Update baseline snapshots'
        required: false
        default: 'false'
        type: boolean

env:
  CI: true
  NODE_VERSION: '20.x'

jobs:
  visual-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Download baseline snapshots
        uses: actions/cache@v4
        id: baseline-cache
        with:
          path: tests/visual/baselines
          key: visual-baselines-${{ github.base_ref || github.ref_name }}-${{ hashFiles('src/renderer/**/*.tsx', 'src/renderer/**/*.css') }}
          restore-keys: |
            visual-baselines-${{ github.base_ref || github.ref_name }}-
            visual-baselines-main-
            visual-baselines-

      - name: Run visual tests
        id: visual-tests
        run: |
          if [[ "${{ github.event.inputs.update_snapshots }}" == "true" ]]; then
            npm run test:visual:update
          else
            npm run test:visual
          fi
        env:
          UPDATE_SNAPSHOTS: ${{ github.event.inputs.update_snapshots }}
        continue-on-error: true

      - name: Upload baseline snapshots
        if: github.event.inputs.update_snapshots == 'true' || steps.baseline-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: tests/visual/baselines
          key: visual-baselines-${{ github.ref_name }}-${{ hashFiles('src/renderer/**/*.tsx', 'src/renderer/**/*.css') }}

      - name: Upload visual diff artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-diffs
          path: |
            tests/visual/diffs/
            tests/visual/reports/
          retention-days: 30

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/visual/reports/
          retention-days: 30

      - name: Comment on PR with visual diff summary
        if: github.event_name == 'pull_request' && steps.visual-tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let summary = '## Visual Regression Test Results\n\n';
            summary += ':warning: **Visual differences detected!**\n\n';

            // Read summary JSON if available
            const summaryPath = 'tests/visual/reports/visual-summary.json';
            if (fs.existsSync(summaryPath)) {
              const report = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
              summary += `- **Total Tests:** ${report.totalTests}\n`;
              summary += `- **Passed:** ${report.passedTests}\n`;
              summary += `- **Failed:** ${report.failedTests}\n\n`;

              if (report.failedTests > 0) {
                summary += '### Failed Tests\n\n';
                const failed = report.results.filter(r => !r.passed);
                for (const result of failed.slice(0, 10)) {
                  summary += `- \`${result.testName}\`\n`;
                }
                if (failed.length > 10) {
                  summary += `- ... and ${failed.length - 10} more\n`;
                }
              }
            }

            summary += '\n\n**Download the `visual-diffs` artifact to review the changes.**\n';
            summary += 'To update baselines, run the workflow manually with "Update baseline snapshots" checked.\n';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

      - name: Fail if visual tests failed
        if: steps.visual-tests.outcome == 'failure'
        run: exit 1

  update-baselines:
    name: Update Baselines (Manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.update_snapshots == 'true'
    needs: visual-tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download updated baselines
        uses: actions/download-artifact@v4
        with:
          name: visual-diffs
          path: tests/visual/

      - name: Commit updated baselines
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Copy new baselines
          if [ -d "tests/visual/baselines" ]; then
            git add tests/visual/baselines/

            if git diff --staged --quiet; then
              echo "No baseline changes to commit"
            else
              git commit -m "chore(visual): update baseline snapshots

              Updated visual regression test baselines via CI workflow.

              Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
              git push
            fi
          fi
